<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قدرات الطالب - المدرسة العربية</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #d1e7fd 100%);
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 1.2s cubic-bezier(.68,-0.55,.27,1.55);
        }
        .bg-shape { position: absolute; border-radius: 50%; opacity: 0.18; z-index: 0; animation: float 8s ease-in-out infinite; }
        .bg-shape1 { width: 160px; height: 160px; background: #ffd700; top: 5%; left: 10%; animation-delay: 0s; }
        .bg-shape2 { width: 120px; height: 120px; background: #81d4fa; bottom: 10%; right: 12%; animation-delay: 2s; }
        .bg-shape3 { width: 90px; height: 90px; background: #a5d6a7; top: 60%; left: 70%; animation-delay: 4s; }
        .star { position: absolute; width: 20px; height: 20px; background: url('https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2b50.png') no-repeat center/contain; opacity: 0.6; animation: starFloat 8s linear infinite; z-index: 1; }
        .star1 { top: 20%; left: 80%; animation-delay: 0s; }
        .star2 { top: 70%; left: 30%; animation-delay: 2s; }
        .star3 { top: 50%; left: 60%; animation-delay: 4s; }
        @keyframes starFloat { 0% { transform: translateY(0) scale(1); opacity: 0.6; } 50% { transform: translateY(-30px) scale(1.2); opacity: 1; } 100% { transform: translateY(0) scale(1); opacity: 0.6; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-30px); } }
        .student-card { border-radius: 2rem; box-shadow: 0 12px 32px rgba(0,0,0,0.18); background: rgba(255,255,255,0.95); padding: 2rem 2.5rem; margin: 2rem auto; max-width: 900px; position: relative; z-index: 2; animation: cardFadeIn 1.2s cubic-bezier(.68,-0.55,.27,1.55); }
        @keyframes cardFadeIn { 0% { opacity: 0; transform: scale(0.92) translateY(60px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        .category-header { background: #fffbe7; color: #b8860b; font-weight: bold; font-size: 1.15rem; text-align: center; letter-spacing: 1px; border-top: 2px solid #ffd700; border-bottom: 2px solid #ffd700; }
        .badge-levels { display: flex; gap: 0.4rem; justify-content: center; align-items: center; }
        .badge-icon { font-size: 2.2rem; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin: 0 2px; box-shadow: 0 0 8px 0 rgba(0,0,0,0.08); border: 2px solid #fff; transition: box-shadow 0.3s, transform 0.3s, filter 0.3s, background 0.3s; position: relative; opacity: 0.55; filter: grayscale(0.7); cursor: pointer; background: #f3f3f3; }
        .badge-icon.selected {
            opacity: 1;
            filter: none;
            background: #fffbe7;
            border: 2px solid #ffd700;
            z-index: 2;
            transform: scale(1.16);
        }
        .badge-icon.selected.level-none {
            animation: glow-blue 1.1s infinite linear alternate;
        }
        .badge-icon.selected.level-intermediate {
            animation: glow-green 1.1s infinite linear alternate;
        }
        .badge-icon.selected.level-master {
            animation: glow-red 1.1s infinite linear alternate;
        }
        @keyframes glow-blue {
            0% { box-shadow: 0 0 3.6px 0.6px #90caf9, 0 0 0 0 #90caf9; }
            100% { box-shadow: 0 0 9.6px 3.6px #42a5f5, 0 0 7.2px 3.6px #42a5f5; }
        }
        @keyframes glow-green {
            0% { box-shadow: 0 0 3.6px 0.6px #a5d6a7, 0 0 0 0 #a5d6a7; }
            100% { box-shadow: 0 0 9.6px 3.6px #43a047, 0 0 7.2px 3.6px #43a047; }
        }
        @keyframes glow-red {
            0% { box-shadow: 0 0 3.6px 0.6px #ef9a9a, 0 0 0 0 #ef9a9a; }
            100% { box-shadow: 0 0 9.6px 3.6px #e53935, 0 0 7.2px 3.6px #e53935; }
        }
        .badge-icon.selected.level-master {
            background: #ffd700;
            color: #b8860b;
            border: 2px solid #e53935;
        }
        .badge-icon.selected.level-intermediate { background: #81d4fa; color: #01579b; border: 2px solid #01579b; }
        .badge-icon.selected.level-none { background: #e0e0e0; color: #888; border: 2px solid #888; }
        .curriculum-table th, .curriculum-table td { text-align: center; vertical-align: middle; }
        .curriculum-table th { background: #e3f2fd; color: #1565c0; font-size: 1.1rem; }
        .curriculum-table td { background: #f9f9f9; transition: background 0.3s; }
        .curriculum-table tr:hover td { background: #fffde7; }
        /* --- SUPER BADGES --- */
        .super-badges-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.2rem;
            justify-content: center;
            align-items: flex-start;
            max-width: 800px;
            margin: 1.5rem auto 1.5rem auto;
        }
        .super-badge-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 150px;
        }
        .super-badge-label {
            margin-top: 0.3rem;
            font-size: 1.05rem;
            color: #888;
            text-align: center;
            font-weight: 500;
            word-break: break-word;
        }
        .super-badge-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 150px;
            min-width: 150px;
            max-width: 150px;
            height: 150px;
            min-height: 150px;
            max-height: 150px;
            box-sizing: border-box;
            font-size: 3.2rem;
            border-radius: 50%;
            border: 4px solid #eee;
            background: #fafafa;
            margin: 0 4px;
            box-shadow: 0 0 18px #eee;
            transition: border 0.2s, box-shadow 0.2s, background 0.2s;
            position: relative;
            overflow: hidden;
        }
        .super-badge-icon svg, .super-badge-icon img {
            width: 70% !important;
            height: 70% !important;
            object-fit: contain;
            display: block;
            margin: auto;
        }
        .super-badge-icon.active {
            opacity: 1;
            filter: none;
            background: #ffd700;
            border: 8px solid #b8860b;
            box-shadow: 0 0 32px #ffd70044, 0 0 0 0 #ffe066;
            transform: scale(1.04);
            animation: super-badge-glow 1.6s infinite alternate cubic-bezier(.4,0,.2,1);
        }
        /* --- NEWLY CHANGED SUPER BADGE EFFECT --- */
        .super-badge-icon.newly-changed {
            box-shadow: 0 0 0 4px #e5393540, 0 0 20px 8px #e5393533, 0 0 32px #ffd70044;
            border: 8px solid #e53935;
            position: relative;
            animation: newly-changed-pulse 1.2s infinite alternate cubic-bezier(.4,0,.2,1);
        }
        @keyframes newly-changed-pulse {
            0% { box-shadow: 0 0 0 4px #e5393540, 0 0 20px 8px #e5393533, 0 0 32px #ffd70044; }
            60% { box-shadow: 0 0 0 10px #e5393555, 0 0 36px 16px #e5393533, 0 0 32px #ffd70044; }
            100% { box-shadow: 0 0 0 4px #e5393540, 0 0 20px 8px #e5393533, 0 0 32px #ffd70044; }
        }
        .super-badge-icon .newly-changed-label {
            position: absolute;
            top: 7px;
            left: 7px;
            background: #e53935;
            color: #fff;
            font-size: 0.97rem;
            font-weight: bold;
            padding: 2px 10px 2px 10px;
            border-radius: 8px 8px 8px 0;
            z-index: 2;
            box-shadow: 0 2px 8px #e5393530;
            pointer-events: none;
            letter-spacing: 0.5px;
            opacity: 0.93;
            font-family: 'Cairo', 'Tahoma', Arial, sans-serif;
        }
        @keyframes super-badge-glow {
            0% {
                box-shadow: 0 0 32px #ffd70044, 0 0 0 0 #ffe066;
            }
            70% {
                box-shadow: 0 0 36px 12px #ffe06688, 0 0 0 0 #ffe066;
            }
            100% {
                box-shadow: 0 0 32px #ffd70044, 0 0 16px 8px #ffe06688;
            }
        }
        .super-badge-icon.inactive {
            filter: grayscale(0.8);
            background: #eee;
            border: 8px solid #ccc;
            opacity: 0.4;
        }
        /* --- ENHANCED INFO CARDS OVERRIDE --- */
        .student-info-cards {
            gap: 2.2rem !important;
            margin-bottom: 2.5rem !important;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .info-card {
            background: linear-gradient(135deg, #fffbe7 60%, #e3f0fa 100%);
            border-radius: 1.5rem;
            box-shadow: 0 8px 36px 0 rgba(24,64,128,0.22), 0 2px 12px 0 rgba(0,0,0,0.12);
            border: 3px solid #7fc7f7;
            min-width: 260px;
            max-width: 340px;
            flex: 1 1 260px;
            padding: 1.4rem 1.7rem 1.2rem 1.7rem;
            margin: 0.8rem 0.8rem 0.8rem 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: box-shadow 0.25s, transform 0.18s, border-color 0.18s;
            position: relative;
            z-index: 3;
            font-size: 1.13rem;
        }
        .info-card:hover {
            box-shadow: 0 18px 48px 0 rgba(24,64,128,0.34), 0 4px 24px 0 rgba(0,0,0,0.15);
            border-color: #1769aa;
            transform: translateY(-7px) scale(1.045);
            background: linear-gradient(135deg, #fffbe7 30%, #c4e3fa 100%);
            cursor: pointer;
        }
        .info-icon {
            font-size: 2.4rem;
            margin-bottom: 0.55rem;
            background: #e3f0fa;
            border-radius: 50%;
            box-shadow: 0 2px 10px #b6d8f7;
            padding: 0.6rem 1rem;
            color: #1769aa;
            border: 2px solid #ffd700;
        }
        .info-label {
            font-weight: bold;
            color: #1769aa;
            margin-bottom: 0.45rem;
            font-size: 1.18rem;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 0 #fffbe7;
        }
        .info-content {
            padding: 0;
            width: 100%;
            min-height: 40px;
            overflow: visible;
            word-break: break-word;
            display: block;
        }
        .info-date {
            color: #888;
            font-size: 0.97rem;
            margin-top: 0.2rem;
            text-align: center;
        }
    </style>
</head>
<body>
    {% if error_message %}
    <div class="alert alert-danger text-center mt-5" role="alert" style="font-size:1.3rem;">
        {{ error_message }}
    </div>
    {% else %}
    <div class="d-flex justify-content-between align-items-center mb-4" style="padding-top: 24px;">
        <div class="text-start" style="min-width:120px;">
            <a href="/logout" class="btn btn-danger btn-sm" style="font-weight:bold; min-width:100px;">تسجيل الخروج</a>
        </div>
        <div class="text-center w-100">
            <img src="/static/{{ school_info.logo }}" alt="شعار المدرسة" style="max-height: 80px; margin-bottom: 8px;">
            <h1 style="font-size:2.1rem; font-weight:bold; margin-bottom:0;">{{ school_info.name }}</h1>
        </div>
        <div></div>
    </div>
    <div class="bg-shape bg-shape1"></div>
    <div class="bg-shape bg-shape2"></div>
    <div class="bg-shape bg-shape3"></div>
    <div class="star star1"></div>
    <div class="star star2"></div>
    <div class="star star3"></div>
    {% endif %}
    <div class="student-card">
        <h3 class="mb-2 text-center" style="color:#1769aa; font-weight:700;">
                     {% if student_name %}
            <span style="font-family:inherit; font-size:inherit; font-weight:inherit; color:#7c3aed;">{{ student_name }}</span>
            {% endif %}
        </h3>
        {% if class_name or class_level %}
        <div class="text-center" style="font-size:1.02rem; color:#222; font-weight:500; margin-bottom:1.2rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
            <span style="font-size:0.97rem; color:#111; font-weight:400;">
              القسم 
                {% if class_name %}{{ class_name }}{% endif %}            
                {% if class_level %} <span style="color:#444;">-  المستوى
                  {{ class_level }}</span>{% endif %}
            </span>
            <a href="/score_card/{{ student_id }}" target="_blank" class="btn btn-outline-primary btn-sm" style="min-width: 150px; font-weight:600;">
                <i class="bi bi-clipboard2-data" style="margin-left:4px;"></i> بطاقة الدرجات
            </a>
        </div>
        {% endif %}
        <!-- Homework Section -->
        {% if homeworks and homeworks|length > 0 %}
        <div class="mb-4 d-flex justify-content-center">
            <div class="info-card w-100" style="max-width:700px; min-height: 220px; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 2rem 1.5rem 1.5rem 1.5rem; overflow: visible; background: linear-gradient(135deg,#fffbe7 0%,#e3f0fa 100%); box-shadow: 0 8px 32px rgba(23,105,170,0.08); border-radius: 1.4rem;">
                <div class="info-icon" title="واجب منزلي">📚</div>
                <div class="info-label" style="margin-bottom:1.2rem;">الواجبات المنزلية</div>
                <div class="info-content" style="padding:0; overflow-y: auto; max-height: 300px;">
                    <ul class="list-unstyled mb-0" style="padding-right:0;">
                        {% for hw in homeworks %}
                        <li style="border-bottom:1px solid #e3f0fa; padding: 0.7rem 0;">
                            <div style="font-weight:600; color:#1769aa;">{{ hw.description or 'بدون عنوان' }}</div>
                            <div class="info-date" style="margin-bottom:0.2rem;">تاريخ التسليم: {{ hw.due_date }}</div>
                            {% if hw.files and hw.files|length > 0 %}
                            <div style="margin-bottom:0.2rem;">
                                <span style="color:#1769aa;font-weight:500;">المستندات:</span>
                                {% for file in hw.files %}
                                    <a href="/uploads/class_{{ class_id }}/{{ file }}" target="_blank" style="color:#0d47a1;word-break:break-all;">{{ file }}</a>{% if not loop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
        <!-- Super Badges Section -->
        <div id="student-info-cards" class="student-info-cards d-flex flex-wrap gap-3 mb-4 justify-content-center"></div>
        <div class="super-badges-title" style="text-align:center; font-size:2.2rem; font-weight:bold; margin: 32px 0 8px 0; color:#e6b800; display:flex; align-items:center; justify-content:center; gap:18px;">
    <span style="flex:unset; display:flex; align-items:center; gap:10px;">
        <span>الشارات المميزة</span>
        <button id="super-badges-notes-btn" class="super-badge-notes-btn" title="ملاحظات الشارات" type="button" style="padding:0; margin:0; vertical-align:middle; display:flex; align-items:center; justify-content:center;">
    <span id="super-badges-notes-icon" style="font-size:1.55rem; min-width:110px; min-height:66px; padding:10px 21px; border-radius:15px; background:#ffeaea; color:#e53935; font-weight:bold; display:flex; align-items:center; justify-content:center; text-align:center;">...</span>
</button>
    </span>
</div>

        <div id="super-badges-row" class="super-badges-row"></div>
        {% if editable %}
        <div style="text-align:center;margin:16px 0;">
            <button id="save-super-badges-btn" class="btn btn-warning" style="display:none;min-width:180px;" onclick="saveSuperBadges()">حفظ الشارات المميزة</button>
        </div>
        {% endif %}
        <table class="table curriculum-table" id="abilities-table">
            <thead>
                <tr>
                    <th>المقرر</th>
                    <th>المستوى</th>
                    <th>ملاحظات</th>
                </tr>
            </thead>
            <tbody>
                {% for group in groups %}
                    <tr class="category-header"><td colspan="3">{{ group.group_name }}</td></tr>
                    {% for item in group["items"] %}
                    <tr>
                        <td>{{ item.name }}</td>
                        <td>
                            {% if editable %}
                                <div class="badge-levels ability-badges" data-course-id="{{ item.id }}">
                                    {% for badge in level_badges %}
                                    <span class="badge-icon{% if scores[item.id]|default(0)==loop.index0 %} selected {{ badge.class }}{% endif %}" data-level="{{ loop.index0 }}" data-course-id="{{ item.id }}">{{ badge.icon }}</span>
                                    {% endfor %}
                                </div>
                                <input type="hidden" name="score_{{ item.id }}" class="selected-level-input" data-course-id="{{ item.id }}" value="{{ scores[item.id]|default(0) }}">
                            {% else %}
                                <div class="badge-levels ability-badges" data-course-id="{{ item.id }}">
                                    {% for badge in level_badges %}
                                    <span class="badge-icon{% if scores[item.id]|default(0)==loop.index0 %} selected {{ badge.class }}{% endif %}" data-level="{{ loop.index0 }}" data-course-id="{{ item.id }}">{{ badge.icon }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm comment-btn d-flex align-items-center justify-content-center"
                                style="width:32px;height:32px;border-radius:6px;padding:0;background: {{ comments[item.id]|default('') and '#ffcdd2' or '#e0e0e0' }}; color: {{ comments[item.id]|default('') and '#b71c1c' or '#888' }}; border: none; outline: none; font-size: 1.3rem; font-weight: bold;"
                                data-course-id="{{ item.id }}"
                                data-comment="{{ comments[item.id]|default('')|e }}">
                                {% if comments[item.id]|default('') %}
                                    <!-- Letter م for existing comment -->
                                    <span style="font-family: 'Cairo', 'Tahoma', Arial, sans-serif;">م</span>
                                {% else %}
                                    <!-- 3 dots for empty comment -->
                                    <span style="font-size:1.6rem;letter-spacing:2px;">...</span>
                                {% endif %}
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% endfor %}
            </tbody>
        </table>
        {% if editable %}
        <div class="text-center">
            <button class="btn btn-success" id="save-abilities-btn">حفظ التقييمات</button>
        </div>
        {% endif %}
    </div>
    <!-- Super Badges Notes Modal -->

    <!-- Curriculum/Course Comment Modal -->
    <div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header d-flex flex-row-reverse align-items-center justify-content-between">
            <h5 class="modal-title ms-2" id="commentModalLabel">ملاحظات المقرر</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
          </div>
          <div class="modal-body">
            <div id="comment-meta-info" class="mb-2 text-muted small" style="text-align:right;"></div>
            <textarea id="commentText" class="form-control" rows="4" placeholder="أدخل الملاحظة هنا..."></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            {% if editable %}
            <button type="button" class="btn btn-primary" id="saveCommentBtn">حفظ الملاحظة</button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="superBadgesNotesModal" tabindex="-1" aria-labelledby="superBadgesNotesModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header d-flex flex-row-reverse align-items-center justify-content-between">
            <h5 class="modal-title ms-2" id="superBadgesNotesModalLabel">ملاحظات الشارات المميزة</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
          </div>
          <div class="modal-body">
            <div id="super-badges-notes-meta-info" class="mb-2 text-muted small" style="text-align:right;"></div>
            <textarea id="superBadgesNotesText" class="form-control" rows="4" placeholder="أدخل الملاحظة هنا..." {% if not editable %}readonly{% endif %}></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>

            {% if editable %}
<button type="button" class="btn btn-primary" id="saveSuperBadgesNotesBtn">حفظ الملاحظة</button>

            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <script>
        let currentCommentCourseId = null;
        document.querySelectorAll('.comment-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            currentCommentCourseId = btn.getAttribute('data-course-id');
            const comment = btn.getAttribute('data-comment') || '';
            // Get meta info from global JS object
            const meta = window.commentMeta && window.commentMeta[currentCommentCourseId] ? window.commentMeta[currentCommentCourseId] : null;
            let metaText = '';
            if (meta && (meta.updated_at || meta.user)) {
              if (meta.updated_at) metaText += 'آخر تعديل: ' + meta.updated_at;
              if (meta.user) metaText += ' بواسطة ' + meta.user;
            }
            document.getElementById('comment-meta-info').textContent = metaText;
            document.getElementById('commentText').value = comment;
            var commentModal = new bootstrap.Modal(document.getElementById('commentModal'));
            commentModal.show();
          });
        });

        // Cleanup lingering modal state after modal is hidden
        document.addEventListener('hidden.bs.modal', function () {
            document.body.classList.remove('modal-open');
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        });


    {% if editable %}
document.addEventListener('DOMContentLoaded', function() {
    // Badge selection logic
    document.querySelectorAll('.ability-badges').forEach(function(container) {
        container.addEventListener('click', function(e) {
            if(e.target.classList.contains('badge-icon')) {
                const badges = container.querySelectorAll('.badge-icon');
                badges.forEach(b => b.classList.remove('selected', 'level-none', 'level-intermediate', 'level-master'));
                const level = e.target.getAttribute('data-level');
                const badgeClass = e.target.className.match(/level-(none|intermediate|master)/);
                e.target.classList.add('selected');
                if (badgeClass) e.target.classList.add(badgeClass[0]);
                // Set hidden input value
                const courseId = container.getAttribute('data-course-id');
                document.querySelector('input.selected-level-input[data-course-id="' + courseId + '"]').value = level;
            }
        });
    });
    
    // Comment button logic
    let currentCommentCourseId = null;
    document.querySelectorAll('.comment-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        currentCommentCourseId = btn.getAttribute('data-course-id');
        const comment = btn.getAttribute('data-comment') || '';
        // Get meta info from global JS object
        const meta = window.commentMeta && window.commentMeta[currentCommentCourseId] ? window.commentMeta[currentCommentCourseId] : null;
        let metaText = '';
        if (meta && (meta.updated_at || meta.user)) {
          if (meta.updated_at) metaText += 'آخر تعديل: ' + meta.updated_at;
          if (meta.user) metaText += ' بواسطة ' + meta.user;
        }
        document.getElementById('comment-meta-info').textContent = metaText;
        document.getElementById('commentText').value = comment;
        var commentModal = new bootstrap.Modal(document.getElementById('commentModal'));
        commentModal.show();
      });
    });
    document.getElementById('saveCommentBtn').onclick = function() {
      const text = document.getElementById('commentText').value.trim();
      // Store in hidden input or update a JS object for later save (to be sent to backend)
      const btn = document.querySelector('.comment-btn[data-course-id="' + currentCommentCourseId + '"]');
      btn.setAttribute('data-comment', text);
      btn.style.background = text ? '#ffcdd2' : '#e0e0e0';
      btn.style.color = text ? '#b71c1c' : '#888';
      // Optionally: store in a hidden input for form submission
      let hidden = document.querySelector('input[name="comment_' + currentCommentCourseId + '"]');
      if (!hidden) {
        hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'comment_' + currentCommentCourseId;
        hidden.className = 'comment-hidden-input';
        hidden.setAttribute('data-course-id', currentCommentCourseId);
        document.querySelector('form')?.appendChild(hidden);
      }
      hidden.value = text;
      // INSTANT SAVE: send to backend
      fetch('/save_comment', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({
               student_id: {{ student_id|tojson }},
               course_id: currentCommentCourseId,
               comment: text
           })
       }).then(r => r.json()).then(resp => {
           // Optionally show a toast or check resp.success
           if (resp.success) {
             // Update meta info in JS
             if (window.commentMeta && currentCommentCourseId) {
               window.commentMeta[currentCommentCourseId] = {
                 updated_at: resp.comment_updated_at,
                 user: resp.comment_user
               };
             }
           }
       });
       var commentModal = bootstrap.Modal.getInstance(document.getElementById('commentModal'));
       commentModal.hide();
    };
    document.getElementById('save-abilities-btn').onclick = function() {
        const data = {};
        document.querySelectorAll('input.selected-level-input').forEach(function(input) {
            data[input.getAttribute('data-course-id')] = input.value;
        });
        // Add comments to data
        document.querySelectorAll('.comment-hidden-input').forEach(function(input) {
          data['comment_' + input.getAttribute('data-course-id')] = input.value;
        });
        fetch(window.location.pathname, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        }).then(r => r.json()).then(resp => {
            if(resp.success) alert('تم حفظ التقييمات بنجاح');
            else alert('حدث خطأ أثناء الحفظ');
        });
    };
});
{% else %}
document.addEventListener('DOMContentLoaded', function() {
    // Disable badge icons visually and functionally for students
    document.querySelectorAll('.badge-icon, .super-badge-icon').forEach(function(el) {
        el.classList.add('disabled');
    });
});
{% endif %}
   
    // --- SUPER BADGES LOGIC ---
    // SVG icon map (copied from super_badges.html)
    const svgIcons = [
      {key:'star',svg:`<svg width='96' height='96' viewBox='0 0 24 24'><polygon fill='#ffd600' points='12,2 15,8.5 22,9.3 17,14.1 18.2,21 12,17.8 5.8,21 7,14.1 2,9.3 9,8.5'/></svg>`},
      {key:'award',svg:`<svg width='96' height='96' viewBox='0 0 24 24'><circle cx='12' cy='8' r='6' fill='#ffd54f'/><rect x='10' y='14' width='4' height='8' fill='#ffb300'/></svg>`},
      {key:'gem',svg:`<svg width='96' height='96' viewBox='0 0 24 24'><polygon fill='#00bcd4' points='12,2 22,9 12,22 2,9'/><polygon fill='#b2ebf2' points='12,2 17,9 12,22 7,9'/></svg>`},
      {key:'star4',svg:`<svg width='96' height='96' viewBox='0 0 24 24'><polygon fill='#ffd600' points='12,2 13.5,8 20,8 15.5,12 17,18 12,14 7,18 8.5,12 4,8 10.5,8'/></svg>`},
      {key:'leaf',svg:`<svg width='96' height='96' viewBox='0 0 24 24'><path d='M12 2C7 7 2 17 12 22C22 17 17 7 12 2Z' fill='#43a047'/><path d='M12 2V22' stroke='#2e7d32' stroke-width='2'/></svg>`},
      {key:'rrrr',svg:`<svg width='96' height='96' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10' fill='#ffeb3b'/><text x='12' y='17' font-size='10' text-anchor='middle' fill='#555'>R</text></svg>`},
      {key:'gggg',svg:`<svg width='96' height='96' viewBox='0 0 24 24'><ellipse cx='12' cy='12' rx='10' ry='8' fill='#ffd600'/><circle cx='12' cy='8' r='4' fill='#fffde7'/></svg>`},
      {key:'jewel',svg:`<svg width='96' height='96' viewBox='0 0 24 24'><polygon fill='#b2ebf2' points='12,2 22,9 12,22 2,9'/><polygon fill='#00bcd4' points='12,2 17,9 12,22 7,9'/></svg>`},
    ];
    const studentId = window.studentId || {{ student_id|default('null') }}; // Set from backend context
    const isAdmin = window.isAdmin || {{ is_admin|default('false')|tojson }};

    // Show a loading spinner while fetching badges
    function setSuperBadgesLoading() {
        const row = document.getElementById('super-badges-row');
        row.innerHTML = '<div style="width:100%;text-align:center;padding:10px;">جاري التحميل...</div>';
    }

    // Render all super badges for the student
    function renderSuperBadges(badges) {
        //console.log('[SuperBadges] Rendering badges:', badges);
        const row = document.getElementById('super-badges-row');
        row.innerHTML = '';
        const now = new Date();
        badges.forEach(badge => {
            //console.log('[SuperBadges] RENDERED badges:', badge);
            const colDiv = document.createElement('div');
            colDiv.className = 'super-badge-col';

            const badgeDiv = document.createElement('div');
            badgeDiv.className = 'super-badge-icon ' + (badge.active ? 'active' : 'inactive');
            badgeDiv.title = badge.name;
            badgeDiv.setAttribute('data-badge-id', badge.id); // for pending logic

            // --- NEWLY CHANGED LOGIC ---
            let isNewlyChanged = false;
            if (badge.active && badge.awarded_at) {
                let awardedDate = null;
                if (typeof badge.awarded_at === 'string') {
                    awardedDate = new Date(badge.awarded_at);
                } else if (badge.awarded_at instanceof Date) {
                    awardedDate = badge.awarded_at;
                }
                if (awardedDate && !isNaN(awardedDate.getTime())) {
                    const diffMs = now - awardedDate;
                    const diffDays = diffMs / (1000 * 60 * 60 * 24);
                    //console.log(`[SuperBadges] Badge ${badge.id} awarded_at:`, badge.awarded_at);
                    //console.log(`[SuperBadges] Badge ${badge.id} diffDays:`, diffDays);
                    if (diffDays <= 7) {
                        badgeDiv.classList.add('newly-changed');
                        //console.log(`[SuperBadges] .newly-changed class ADDED for badge ${badge.id}`);
                        const label = document.createElement('div');
                        label.className = 'newly-changed-label';
                        label.textContent = 'جديد!';
                        label.title = 'تم تفعيل الشارة أو تحديثها خلال الأسبوع الحالي';
                        badgeDiv.appendChild(label);
                    }
                }
            }
            // Render icon based on icon_type
            if (badge.icon_type === 'svg' && badge.icon_value && badge.icon_value.trim().startsWith('<svg')) {
                badgeDiv.innerHTML += badge.icon_value;
            } else if (badge.icon_type === 'url' && badge.icon_value && (badge.icon_value.startsWith('http://') || badge.icon_value.startsWith('https://'))) {
                badgeDiv.innerHTML += `<img src="${badge.icon_value}" alt="${badge.name}" style="width: 70%; height: 70%;">`;
            } else if (badge.icon_type === 'key' && badge.icon_value) {
                const iconObj = svgIcons.find(i => i.key === badge.icon_value);
                badgeDiv.innerHTML += iconObj ? iconObj.svg : '<svg width="70%" height="70%"></svg>';
            } else {
                // Placeholder SVG for missing/unknown icon type
                badgeDiv.innerHTML += `<svg width='60' height='60' viewBox='0 0 60 60'><circle cx='30' cy='30' r='28' fill='#eee'/><text x='50%' y='54%' text-anchor='middle' font-size='2.2rem' fill='#bbb'>?</text></svg>`;
            }
            if (isAdmin) {
                badgeDiv.style.cursor = 'pointer';
                badgeDiv.onclick = () => toggleSuperBadge(badge.id, badgeDiv);
            }
            // Add badge and label
            colDiv.appendChild(badgeDiv);
            const labelDiv = document.createElement('div');
            labelDiv.className = 'super-badge-label';
            labelDiv.textContent = badge.name || '';
            colDiv.appendChild(labelDiv);
            row.appendChild(colDiv);
        });
        if (badges.length === 0) {
            row.innerHTML = '<div class="text-muted">لا توجد شارات مميزة بعد</div>';
        }
        // Show/hide save button based on pending changes
        showSaveSuperBadgesBtn();
    }

    // Fetch all super badges and the student's active ones
    function loadSuperBadges() {
        setSuperBadgesLoading();
        fetch(`/api/student/${studentId}/super_badges`)
            .then(r => r.json())
            .then(renderSuperBadges)
            .catch(() => {
                document.getElementById('super-badges-row').innerHTML = '<div class="text-danger">تعذر تحميل الشارات</div>';
            });
    }

    // Toggle badge activation for the student
    // --- Enhanced: Batch Save Super Badges ---
    const pendingSuperBadges = {};
    {% if editable %}
    function toggleSuperBadge(badgeId, badgeDiv) {
        // Only toggle visual state and mark as pending
        badgeDiv.classList.toggle('active');
        badgeDiv.classList.toggle('inactive');
        badgeDiv.classList.add('super-badge-pending');
        // Track new state
        const isNowActive = badgeDiv.classList.contains('active');
        pendingSuperBadges[badgeId] = isNowActive;
        showSaveSuperBadgesBtn();
    }
    {% endif %}
    function showSaveSuperBadgesBtn() {
        const btn = document.getElementById('save-super-badges-btn');
        if (!btn) return;
        btn.style.display = Object.keys(pendingSuperBadges).length > 0 ? '' : 'none';
        btn.disabled = false;
        btn.textContent = 'حفظ الشارات المميزة';
    }
    async function saveSuperBadges() {
        const btn = document.getElementById('save-super-badges-btn');
        if (!btn) return;
        btn.disabled = true;
        btn.textContent = 'جاري الحفظ...';
        try {
            const resp = await fetch(`/api/student/${studentId}/super_badges/batch_update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ badges: pendingSuperBadges })
            });
            const data = await resp.json();
            if (data.success) {
                // Remove pending class
                Object.keys(pendingSuperBadges).forEach(badgeId => {
                    const badgeDiv = document.querySelector(`.super-badge-icon[data-badge-id='${badgeId}']`);
                    if (badgeDiv) badgeDiv.classList.remove('super-badge-pending');
                });
                Object.keys(pendingSuperBadges).forEach(k=>delete pendingSuperBadges[k]);
                showSaveSuperBadgesBtn();
            } else {
                alert('تعذر حفظ الشارات.');
                btn.disabled = false;
                btn.textContent = 'حفظ الشارات المميزة';
            }
        } catch(e) {
            alert('تعذر الاتصال بالخادم.');
            btn.disabled = false;
            btn.textContent = 'حفظ الشارات المميزة';
        }
    }

    document.addEventListener('DOMContentLoaded', loadSuperBadges);
    // Show/hide save button on load
    document.addEventListener('DOMContentLoaded', showSaveSuperBadgesBtn);
    // --- Super Badges Notes Button Logic ---
    async function updateSuperBadgesNotesIcon() {
    console.log('[SuperBadgesNotes] updateSuperBadgesNotesIcon called');
        const icon = document.getElementById('super-badges-notes-icon');
        const btn = document.getElementById('super-badges-notes-btn');
        if (!icon || !btn) return;
        // Always apply the icon class for styling
        icon.classList.add('super-badge-notes-icon');
        try {
            const resp = await fetch(`/api/student/${studentId}/super_badges/notes`);
            const data = await resp.json();
            if (data && data.note && data.note.trim().length > 0) {
                icon.textContent = 'ملاحظات';
                btn.classList.add('has-note');
                btn.classList.remove('no-note');
            } else {
                icon.textContent = '...';
                btn.classList.add('no-note');
                btn.classList.remove('has-note');
            }
        } catch {
            icon.textContent = '...';
            btn.classList.add('no-note');
            btn.classList.remove('has-note');
        }
    }
    let superBadgesNotesModal = null;
    document.addEventListener('DOMContentLoaded', function() {
        updateSuperBadgesNotesIcon();
        const notesBtn = document.getElementById('super-badges-notes-btn');
        const superBadgesNotesModalEl = document.getElementById('superBadgesNotesModal');
        if (superBadgesNotesModalEl) {
            superBadgesNotesModal = bootstrap.Modal.getOrCreateInstance(superBadgesNotesModalEl);
        }
        if (notesBtn) {
            notesBtn.addEventListener('click', async function() {
        console.log('[SuperBadgesNotes] Button clicked');
                // Fetch existing notes (if any)
                const resp = await fetch(`/api/student/${studentId}/super_badges/notes`);
                const data = await resp.json();
                document.getElementById('superBadgesNotesText').value = data && data.note ? data.note : '';
                let metaText = '';
if (data && (data.updated_at || data.user)) {
  if (data.updated_at) metaText += 'آخر تعديل: ' + data.updated_at;
  if (data.user) metaText += ' بواسطة ' + data.user;
}
document.getElementById('super-badges-notes-meta-info').textContent = metaText;
                if (superBadgesNotesModal) superBadgesNotesModal.show();
            });
        }
        {% if editable %}
        const saveBtn = document.getElementById('saveSuperBadgesNotesBtn');
        if (saveBtn) {
            saveBtn.onclick = async function() {
                const text = document.getElementById('superBadgesNotesText').value.trim();
                const resp = await fetch(`/api/student/${studentId}/super_badges/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ note: text })
                });
                const data = await resp.json();
                if (data.success) {
                    let metaText = '';
if (data && (data.updated_at || data.user)) {
  if (data.updated_at) metaText += 'آخر تعديل: ' + data.updated_at;
  if (data.user) metaText += ' بواسطة ' + data.user;
}
document.getElementById('super-badges-notes-meta-info').textContent = metaText;
                    if (superBadgesNotesModal) superBadgesNotesModal.hide();
                    updateSuperBadgesNotesIcon();
                } else {
                    alert('تعذر حفظ الملاحظة');
                }
            };
        }
        {% endif %}
        // Ensure modal closes on cancel or X
        const cancelBtns = superBadgesNotesModalEl ? superBadgesNotesModalEl.querySelectorAll('[data-bs-dismiss="modal"]') : [];
        cancelBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                if (superBadgesNotesModal) superBadgesNotesModal.hide();
            });
        });
    });

    // Make commentMeta available to JS
    window.commentMeta = {{ comment_meta|tojson|safe }};
    </script>
    <script>
    // --- Info Cards for Homework, Event, Announcement ---
    document.addEventListener('DOMContentLoaded', function() {
        //console.log('[InfoCards] Script loaded');
      const infoCardsDiv = document.getElementById('student-info-cards');
      const studentId = window.studentId || {{ student_id|default('null') }};
      const classId = window.classId || {{ class_id|default('null') }};
      //console.log('[InfoCards] studentId:', studentId, 'classId:', classId);
      if (!classId) {
        console.warn('[InfoCards] No classId found, exiting script.');
        return;
      }
      // Helper: format date to Arabic
      function formatDateAr(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        return d.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      }
      // Fetch all three in parallel
      Promise.all([
        fetch(`/api/homework/list/${classId}`).then(r => { console.log('[InfoCards] Homework API response:', r); return r.json(); }),
        fetch(`/api/events/${classId}`).then(r => { console.log('[InfoCards] Events API response:', r); return r.json(); }),
        fetch(`/api/class/${classId}/announcement`).then(r => { console.log('[InfoCards] Announcement API response:', r); return r.json(); })
      ]).then(([hwData, eventsData, annData]) => {
        //console.log('[InfoCards] Homework Data:', hwData);
        //console.log('[InfoCards] Events Data:', eventsData);
        //console.log('[InfoCards] Announcement Data:', annData);
        // --- Homework: Find next future homework ---
        let nextHw = null;
        if(hwData && hwData.success && Array.isArray(hwData.homeworks)) {
          const today = new Date().toISOString().slice(0,10);
          nextHw = hwData.homeworks.filter(hw => hw.due_date >= today).sort((a,b)=>a.due_date.localeCompare(b.due_date))[0];
        }
        // --- Event: Find next future event ---
        let nextEvent = null;
        if(Array.isArray(eventsData)) {
          const now = new Date().toISOString();
          nextEvent = eventsData.filter(ev => ev.start >= now).sort((a,b)=>a.start.localeCompare(b.start))[0];
        }
        // --- Announcement: latest non-expired ---
        let announcement = null;
        if(annData && annData.success && annData.text) {
          if (!annData.expiry) {
            announcement = annData;
          } else {
            const now = new Date();
            const expiryDate = new Date(annData.expiry);
            if (now <= expiryDate) announcement = annData;
          }
        }
        // --- Render Cards ---
        infoCardsDiv.innerHTML = '';

        // Event Card
        infoCardsDiv.innerHTML += `<div class="info-card event-card" tabindex="0" role="button" onclick="window.showEventModal && window.showEventModal(${classId})" title="تفاصيل الحدث">
          <div class="info-icon">📅</div>
          <div class="info-label">الحدث القادم</div>
          <div class="info-content">${nextEvent ? nextEvent.title : 'لا يوجد حدث قادم'}</div>
          <div class="info-date">${nextEvent ? 'تاريخ الحدث: ' + formatDateAr(nextEvent.start) : ''}</div>
        </div>`;
        // Announcement Card
        infoCardsDiv.innerHTML += `<div class="info-card announcement-card" tabindex="0" role="button" onclick="window.showAnnouncementModal && window.showAnnouncementModal(${classId})" title="تفاصيل الإعلان">
          <div class="info-icon">📢</div>
          <div class="info-label">آخر إعلان</div>
          <div class="info-content">${announcement ? announcement.text : 'لا يوجد إعلان حديث'}</div>
          <div class="info-date">${announcement && announcement.created_at ? 'تاريخ: ' + formatDateAr(announcement.created_at) : ''}</div>
        </div>`;
      });
      // Modal openers (assume modals exist)
      window.showHomeworkModal = function(classId) {
        // Trigger homework modal (if exists)
        if(window.bootstrap && document.getElementById('homeworkModal')) {
          document.getElementById('homework-class-id').value = classId;
          new bootstrap.Modal(document.getElementById('homeworkModal')).show();
        }
      };
      window.showEventModal = function(classId) {
        // Could implement event modal here
        alert('تفاصيل الحدث قادمة قريباً!');
      };
      window.showAnnouncementModal = function(classId) {
        if(window.bootstrap && document.getElementById('announcementModal')) {
          document.getElementById('announcementClassId').value = classId;
          // Fetch and show latest announcement in modal
          fetch(`/api/class/${classId}/announcement`).then(r=>r.json()).then(data => {
            document.getElementById('announcementText').innerHTML = data && data.success && data.text ? data.text : '';
            document.getElementById('announcementExpiry').value = data && data.success && data.expiry ? data.expiry : '';
            new bootstrap.Modal(document.getElementById('announcementModal')).show();
          });
        }
      };
    });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      /* Optional: pending feedback style for badge click */
      .super-badge-pending {
        opacity: 0.5;
        pointer-events: none;
        filter: grayscale(1) blur(1px);
      }
      .super-badge-notes-btn {
  border: none !important;
  background: none !important;
  padding: 0 !important;
  margin: 0 6px !important;
  outline: none !important;
  box-shadow: none !important;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 0;
  min-height: 0;
}
.super-badge-notes-btn #super-badges-notes-icon {
  font-size: 1.1rem;
  min-width: 60px;
  padding: 2px 10px;
  border-radius: 8px;
  background: #ffeaea;
  color: #e53935;
  font-weight: bold;
  display: inline-block;
  margin: 0;
}
.super-badge-notes-btn.has-note #super-badges-notes-icon {
  background: #ffeaea !important;
  color: #e53935 !important;
  font-weight: bold !important;
}
.super-badge-notes-btn.no-note #super-badges-notes-icon {
  background: #f3f3f3 !important;
  color: #888 !important;
  font-weight: normal !important;
}
      .super-badge-notes-btn:focus {
        outline: none !important;
        box-shadow: none !important;
      }
      .super-badge-notes-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 10px;
        font-family: 'Cairo', 'Tahoma', Arial, sans-serif;
        font-size: 1.7rem;
        text-align: center;
        transition: background 0.2s, color 0.2s, font-weight 0.2s;
        user-select: none;
      }
      .super-badge-notes-btn.has-note .super-badge-notes-icon {
        background: #ffeaea !important;
        color: #e53935 !important;
        font-weight: bold !important;
      }
      .super-badge-notes-btn.no-note .super-badge-notes-icon {
        background: #f3f3f3 !important;
        color: #888 !important;
        font-weight: normal !important;
      }
    </style>
</body>
</html>
